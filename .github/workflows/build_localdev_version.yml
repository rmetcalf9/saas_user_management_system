name: build_localdev_version

on:
  workflow_dispatch:

jobs:
  build_root_var:
    runs-on: ubuntu-latest

    steps:
      # === prepare stage ===
      - name: Checkout repo
        uses: actions/checkout@v4

      # === build stage ===
      - name: Read Docker credentials from Vault
        uses: hashicorp/vault-action@v3
        with:
          url: ${{ secrets.VAULT_ADDR }}
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}
          exportEnv: false
          secrets: |
            kv/data/robert_accounts/dockerhub/personal_access_tokens/saas_user_management_system_deployment username | DOCKER_USERNAME ;
            kv/data/robert_accounts/dockerhub/personal_access_tokens/saas_user_management_system_deployment password | DOCKER_PASSWORD ;
            kv/data/memset/deployment/ssh SSH_KEY | SSH_KEY ;
            kv/data/memset/deployment/ssh SPLIT_CHAR | SPLIT_CHAR ;
            kv/data/memset/deployment/ssh SSH_PORT | SSH_PORT ;
            kv/data/memset/deployment/ssh RDOCKER_HOST | RDOCKER_HOST

      - name: Unit tests
        run: |
          source ./_repo_vars.sh && \
          echo "Running uint tests for ${PROJECT_NAME}" && \
          docker run --rm -v "$PWD/services:/opt/services" -w /opt/services \
            ${RJM_PYTHON_TEST_IMAGE} \
            sh -c "pip3 install --no-cache-dir -r ./src/requirements.txt && \
                   pip3 install --no-cache-dir -r ./testContainer/requirements.txt && \
                   SKIPSQLALCHEMYTESTS=Y python3 -m pytest ./test"

      - name: Build frontend
        run: |
          source ./_repo_vars.sh && \
          docker run --rm -v "$PWD:/opt/work" -w /opt/work \
            ${QUASARBUILDIMAGE} \
            -c "build_quasar_app ./frontend spa ${RJM_VERSION}"

      - name: Build adminfrontend
        run: |
          source ./_repo_vars.sh && \
          docker run --rm -v "$PWD:/opt/work" -w /opt/work \
            -e OVERRIDE_PUBLIC_PATH="saas_user_management/v${RJM_MAJOR_VERSION}/public/web/adminfrontend/" \
            ${QUASARBUILDIMAGE_ADMINFRONTEND} \
            -c "build_quasar_app ./adminfrontend pwa ${RJM_VERSION} 1536"

      - name: Build main image
        run: |
          source ./_repo_vars.sh && \
          docker build -t metcarob/saas_user_management:${RJM_VERSION} .

      - name: Build test image
        run: |
          source ./_repo_vars.sh && \
          docker build -t metcarob/saas_user_managementtest:develop \
            -f services/testContainer/Dockerfile services/testContainer

      - name: Container level tests
        run: |
          source ./_repo_vars.sh && \
          docker compose -f .github/compose-test.yml up --abort-on-container-exit --exit-code-from saas_user_management_systemtest

      # === buildrootver stage ===

      - name: Clean previous adminfrontend build
        run: |
          source ./_repo_vars.sh && \
          echo "Deleting ./adminfrontend/dist/pwa..."
          docker run --rm \
            -v "$PWD:/work" \
            -w /work \
            ${QUASARBUILDIMAGE_ADMINFRONTEND} \
            -c "rm -rf ./adminfrontend/dist/pwa"
          echo "Directory deleted successfully."

      - name: Build adminfrontend root version
        run: |
          source ./_repo_vars.sh && \
          docker run --rm -v "$PWD:/opt/work" -w /opt/work \
            -e OVERRIDE_PUBLIC_PATH="" \
            ${QUASARBUILDIMAGE_ADMINFRONTEND} \
            -c "build_quasar_app ./adminfrontend pwa ${RJM_VERSION} 1536"

      - name: Build rootver docker image
        run: |
          source ./_repo_vars.sh && \
          docker build -t metcarob/saas_user_management:${RJM_VERSION}_rootver .

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Push rootver image
        run: |
          source ./_repo_vars.sh && \
          docker push metcarob/saas_user_management:${RJM_VERSION}_rootver

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          # Convert the split-char SSH key back into a real multiline key
          echo "${SSH_KEY}" | sed "s/${SPLIT_CHAR}/\n/g" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Add host to known_hosts
          ssh-keyscan -p "${SSH_PORT}" "${RDOCKER_HOST}" >> ~/.ssh/known_hosts          

      # Artifacts created now deploy to server
      - name: Deploy Docker Service to Swarm
        run: |
          source ./_repo_vars.sh && \
          ssh -p "${SSH_PORT}" \
            -i ~/.ssh/id_rsa \
            "${RDOCKER_HOST}" \
            bash -s << 'EOF'
  
          docker service create --name "${RJM_DOCKER_SERVICE_NAME}" \
            --network main_net \
            --secret saas_user_management_system_objectstore_config_dynamodb \
            --secret saas_user_management_system_objectstore_hashpw \
            --secret saas_user_management_system_objectstore_adminpw \
            --secret saas_user_management_system_gateway_config \
            --secret saas_jwtsecret \
            --secret saas_user_management_system_authprov_google \
            --secret saas_user_management_system_authprov_facebook \
            -e APIAPP_JWTSECRETFILE=/run/secrets/saas_jwtsecret \
            -e APIAPP_GATEWAYINTERFACECONFIGFILE=/run/secrets/saas_user_management_system_gateway_config \
            -e APIAPP_OBJECTSTORECONFIGFILE=/run/secrets/saas_user_management_system_objectstore_config_dynamodb \
            -e APIAPP_MASTERPASSWORDFORPASSHASHFILE=/run/secrets/saas_user_management_system_objectstore_hashpw \
            -e APIAPP_DEFAULTHOMEADMINPASSWORDFILE=/run/secrets/saas_user_management_system_objectstore_adminpw \
            -e APIAPP_DEFAULTHOMEADMINUSERNAME=admin \
            -e APIAPP_APIURL=https://api.metcarob.com/api \
            -e APIAPP_APIDOCSURL=https://api.metcarob.com/saas_user_management/v${RJM_MAJOR_VERSION}/public/web/apidocs \
            -e APIAPP_FRONTENDURL=https://api.metcarob.com/saas_user_management/v${RJM_MAJOR_VERSION}/public/web/frontend \
            -e APIAPP_DEFAULTMASTERTENANTJWTCOLLECTIONALLOWEDORIGINFIELD="https://api.metcarob.com,https://localhost,http://localhost" \
            -e APIAPP_OBJECTSTOREDETAILLOGGING="N" \
            --constraint 'node.labels.legacy == true' \
            "metcarob/saas_user_management:${RJM_VERSION}"
  
          EOF

#  # Connect test endpoint to new container
#  ## This connects directly to the container - no upstreams in use for the test endpoint
#  configure_kong_test_PUBLIC_endpoint_to_connect_to_container:
#    stage: deploy
#    image: codefresh/remote-docker
#    working_directory: ${{main_clone}}
#    commands:
#      - rdocker ${{RDOCKER_HOST}} docker run --rm -it --network main_net --entrypoint kong_install_service_and_route
#        ${{RJM_DOCKERWSCALLER_IMAGE}}
#        ${{RJM_DOCKER_KONG_API_URL}}
#        ${{RJM_WS_NAME}}_v${{RJM_MAJOR_VERSION}}_TEST_PUBLIC http ${{RJM_DOCKER_SERVICE_URL}} 80 /public/
#        https api.metcarob.com /${{RJM_WS_NAME}}/test/v${{RJM_MAJOR_VERSION}}/public null null null true
#    environment:
#      - SSH_KEY=${{SSH_KEY_COMMAS}}
#      - SSH_PORT=${{SSH_PORT}}
#      - SPLIT_CHAR=${{SPLIT_CHAR}}
#    retry:
#      maxAttempts: 3
#      delay: 3
#      exponentialFactor: 1
#
#  configure_kong_test_AUTHED_endpoint_to_connect_to_container:
#    stage: deploy
#    image: codefresh/remote-docker
#    working_directory: ${{main_clone}}
#    commands:
#      - rdocker ${{RDOCKER_HOST}} docker run --rm -it --network main_net --entrypoint kong_install_service_and_route
#        ${{RJM_DOCKERWSCALLER_IMAGE}}
#        ${{RJM_DOCKER_KONG_API_URL}}
#        ${{RJM_WS_NAME}}_v${{RJM_MAJOR_VERSION}}_TEST_AUTHED http ${{RJM_DOCKER_SERVICE_URL}} 80 /authed/
#        https api.metcarob.com /${{RJM_WS_NAME}}/test/v${{RJM_MAJOR_VERSION}}/authed null null null true
#    environment:
#      - SSH_KEY=${{SSH_KEY_COMMAS}}
#      - SSH_PORT=${{SSH_PORT}}
#      - SPLIT_CHAR=${{SPLIT_CHAR}}
#    retry:
#      maxAttempts: 3
#      delay: 3
#      exponentialFactor: 1
#
#  #endpoints are secured the first time they are created. This will add the plugins only if they are not there
#  secure_kong_test_AUTHED_endpoint_to_connect_to_container:
#    stage: deploy
#    image: codefresh/remote-docker
#    working_directory: ${{main_clone}}
#    commands:
#      - rdocker ${{RDOCKER_HOST}} docker run --rm -it --network main_net --entrypoint kong_add_jwt_and_acl_plugins
#        ${{RJM_DOCKERWSCALLER_IMAGE}}
#        ${{RJM_DOCKER_KONG_API_URL}}
#        ${{RJM_WS_NAME}}_v${{RJM_MAJOR_VERSION}}_TEST_AUTHED
#        \"${{JWT_COOKIE_NAME}}\"
#        \"${{AUTHED_ACL_WHITELIST}}\"
#        \"${{AUTHED_ACL_BLACKLIST}}\"
#        \"kong_iss\"
#    environment:
#      - SSH_KEY=${{SSH_KEY_COMMAS}}
#      - SSH_PORT=${{SSH_PORT}}
#      - SPLIT_CHAR=${{SPLIT_CHAR}}
#    retry:
#      maxAttempts: 3
#      delay: 3
#      exponentialFactor: 1
#
#  # Test test endpoint including version test
#  ## This is tried a number of times with an increasing delay.
#  ## This gives the docker service time to start and become healthy
#  run_container_tests_against_test_endpoint:
#    stage: deploy
#    image: ${{build_the_test_image}}
#    working_directory: ${{main_clone}}/server
#    commands:
#      - python3 -m pytest /ext_volume
#    environment:
#      - EXPECTED_CONTAINER_VERSION=${{RJM_VERSION}}
#      - BASEURL_TO_TEST=https://api.metcarob.com/${{RJM_WS_NAME}}/test/v${{RJM_MAJOR_VERSION}}
#      - HTTPORIGIN_TO_TEST=https://api.metcarob.com
#      - RUNNINGVIAKONG="TRUE"
#      - APIAPP_DEFAULTHOMEADMINUSERNAME=codefresh_test_user
#      - APIAPP_DEFAULTHOMEADMINPASSWORD=${{CODEFRESH_TEST_USER_PASSWORD}}
#    retry:
#      maxAttempts: 3
#      delay: 30
#      exponentialFactor: 1
#
#  #Deploys the prod kong endpoint
#  ## the serivce target is not the container, instead it is the upstream
#  ## this won't work until the upstream is in place
#  configure_kong_prod_PUBLIC_endpoint:
#    stage: deploy
#    image: codefresh/remote-docker
#    working_directory: ${{main_clone}}
#    commands:
#      - rdocker ${{RDOCKER_HOST}} docker run --rm -it --network main_net --entrypoint kong_install_service_and_route
#        ${{RJM_DOCKERWSCALLER_IMAGE}}
#        ${{RJM_DOCKER_KONG_API_URL}}
#        ${{RJM_WS_NAME}}_v${{RJM_MAJOR_VERSION}}_PUBLIC http ${{RJM_KONG_UPSTREAM_NAME}} 80 /public/
#        https api.metcarob.com /${{RJM_WS_NAME}}/v${{RJM_MAJOR_VERSION}}/public null null null true
#    environment:
#      - SSH_KEY=${{SSH_KEY_COMMAS}}
#      - SSH_PORT=${{SSH_PORT}}
#      - SPLIT_CHAR=${{SPLIT_CHAR}}
#    retry:
#      maxAttempts: 3
#      delay: 3
#      exponentialFactor: 1
#
#  configure_kong_prod_AUTHED_endpoint:
#    stage: deploy
#    image: codefresh/remote-docker
#    working_directory: ${{main_clone}}
#    commands:
#      - rdocker ${{RDOCKER_HOST}} docker run --rm -it --network main_net --entrypoint kong_install_service_and_route
#        ${{RJM_DOCKERWSCALLER_IMAGE}}
#        ${{RJM_DOCKER_KONG_API_URL}}
#        ${{RJM_WS_NAME}}_v${{RJM_MAJOR_VERSION}}_AUTHED http ${{RJM_KONG_UPSTREAM_NAME}} 80 /authed/
#        https api.metcarob.com /${{RJM_WS_NAME}}/v${{RJM_MAJOR_VERSION}}/authed null null null true
#    environment:
#      - SSH_KEY=${{SSH_KEY_COMMAS}}
#      - SSH_PORT=${{SSH_PORT}}
#      - SPLIT_CHAR=${{SPLIT_CHAR}}
#    retry:
#      maxAttempts: 3
#      delay: 3
#      exponentialFactor: 1
#
#  #endpoints are secured the first time they are created. This will add the plugins only if they are not there
#  secure_kong_prod_AUTHED_endpoint:
#    stage: deploy
#    image: codefresh/remote-docker
#    working_directory: ${{main_clone}}
#    commands:
#      - rdocker ${{RDOCKER_HOST}} docker run --rm -it --network main_net --entrypoint kong_add_jwt_and_acl_plugins
#        ${{RJM_DOCKERWSCALLER_IMAGE}}
#        ${{RJM_DOCKER_KONG_API_URL}}
#        ${{RJM_WS_NAME}}_v${{RJM_MAJOR_VERSION}}_AUTHED
#        \"${{JWT_COOKIE_NAME}}\"
#        \"${{AUTHED_ACL_WHITELIST}}\"
#        \"${{AUTHED_ACL_BLACKLIST}}\"
#        \"kong_iss\"
#    environment:
#      - SSH_KEY=${{SSH_KEY_COMMAS}}
#      - SSH_PORT=${{SSH_PORT}}
#      - SPLIT_CHAR=${{SPLIT_CHAR}}
#    retry:
#      maxAttempts: 3
#      delay: 3
#      exponentialFactor: 1
#
#  configure_kong_prod_upstream:
#    stage: deploy
#    image: codefresh/remote-docker
#    working_directory: ${{main_clone}}
#    commands:
#      - rdocker ${{RDOCKER_HOST}} docker run --rm -it --network main_net --entrypoint kong_add_upstream
#        ${{RJM_DOCKERWSCALLER_IMAGE}}
#        ${{RJM_DOCKER_KONG_API_URL}}
#        ${{RJM_KONG_UPSTREAM_NAME}}
#        ${{RJM_DOCKER_SERVICE_URL}}:80
#        remove_other_targets
#    environment:
#      - SSH_KEY=${{SSH_KEY_COMMAS}}
#      - SSH_PORT=${{SSH_PORT}}
#      - SPLIT_CHAR=${{SPLIT_CHAR}}
#    retry:
#      maxAttempts: 3
#      delay: 3
#      exponentialFactor: 1
#
#  approveCleanUpOldVersion:
#    stage: postdeploy
#    type: pending-approval
#    title: Check prod version is working
#    description: Check prod version ${{RJM_VERSION}} before continuing pipeline and destorying old versions
#    timeout:
#      duration: 2
#      finalState: denied
#
#  cleanUpOldVersion:
#    stage: postdeploy
#    image: codefresh/remote-docker
#    working_directory: ${{main_clone}}
#    commands:
#      - rdocker ${{RDOCKER_HOST}} docker run --rm -it --network main_net --volume=/var/run:/var/run --entrypoint docker_service_remove_non_live
#        ${{RJM_DOCKERWSCALLER_IMAGE}}
#        ${{RJM_WS_NAME}}
#        ${{RJM_VERSION}}
#        metcarob/
#    environment:
#      - SSH_KEY=${{SSH_KEY_COMMAS}}
#      - SSH_PORT=${{SSH_PORT}}
#      - SPLIT_CHAR=${{SPLIT_CHAR}}
#    when:
#      steps:
#      - name: approveCleanUpOldVersion
#        on:
#        - approved
#    retry:
#      maxAttempts: 2
#      delay: 3
#      exponentialFactor: 1
